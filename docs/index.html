<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sanasto</title>

<style>
body{font-family:system-ui,Arial;margin:0;background:#f3f4f6;color:#111;font-size:16px;}
header{background:#fff;border-bottom:1px solid #e5e7eb;padding:12px 18px;display:flex;justify-content:space-between;align-items:center;}
.layout{display:grid;grid-template-columns:320px 1fr;gap:16px;padding:16px;}
@media (max-width:800px){.layout{grid-template-columns:1fr;}}
.panel{background:#fff;border:1px solid #e5e7eb;border-radius:10px;}
.list{max-height:80vh;overflow:auto}
.schemeHeader{padding:10px 12px;font-weight:600;background:#f9fafb;border-bottom:1px solid #eee}
.item{padding:10px 12px;border-bottom:1px solid #eee}
.item a{font-weight:600;text-decoration:none;color:#2563eb}
.concept{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:18px;}
h1{margin:0 0 6px;font-size:24px}
.section{margin-top:18px}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #eee;padding:8px;font-size:13px}
th{background:#f9fafb;text-align:left}
.link{color:#2563eb;text-decoration:none}
.dropdown{position:relative;display:inline-block;margin-left:8px}
.dropbtn{padding:6px 10px;border:1px solid #d1d5db;border-radius:6px;background:#fff;cursor:pointer}
.dropdown-content{display:none;position:absolute;background:#fff;border:1px solid #d1d5db;border-radius:6px;min-width:180px;z-index:10;padding:6px;}
.dropdown:hover .dropdown-content{display:block}
.dropdown-content div{padding:6px;cursor:pointer}
.dropdown-content div:hover{background:#f3f4f6}
.search{padding:6px 10px;border:1px solid #d1d5db;border-radius:6px;width:200px}
.feedbackBox{margin-top:28px;padding-top:12px;border-top:1px solid #e5e7eb;}
.feedbackHint{color:#6b7280;font-size:14px;margin-bottom:6px;}
</style>
</head>

<body>
<header>
  <div id="title">Sanasto</div>

  <div>
    <input id="search" class="search" placeholder="Search">

    <div class="dropdown">
      <button class="dropbtn" id="langBtn">FI</button>
      <div class="dropdown-content">
        <div onclick="setLang('fi')">Suomi (FI)</div>
        <div onclick="setLang('sv')">Svenska (SV)</div>
        <div onclick="setLang('en')">English (EN)</div>
      </div>
    </div>

    <div class="dropdown">
      <button class="dropbtn" id="schemeBtn">Sanasto</button>
    </div>
  </div>
</header>

<div class="layout">
  <div class="panel">
    <div class="list" id="list"></div>
  </div>
  <div class="concept" id="view">Valitse käsite</div>
</div>

<script>
/* ========= UI ========= */
const UI={
  fi:{vocab:"Sanasto",feedbackHint:"Voit antaa palautetta käsitteestä sanaston vastuuorganisaatiolle.",feedbackLink:"Anna palautetta käsitteestä"},
  sv:{vocab:"Ordlistor",feedbackHint:"Du kan ge respons om begreppet.",feedbackLink:"Ge respons om begreppet"},
  en:{vocab:"Terminologies",feedbackHint:"You can give feedback about the concept.",feedbackLink:"Give feedback"}
};

let db,concepts=[],schemes=[],map={};
let currentLang="fi";

const BASE_URI="https://teemualaluusua.github.io/sanasto1/#/concept/";
const ISSUES_REPO_URL="https://github.com/teemualaluusua/sanasto1";

/* ========= TOP BAR ========= */
function updateTopBar(){
  document.getElementById("schemeBtn").textContent=UI[currentLang].vocab;
}

/* ========= LOAD ========= */
fetch("sanasto.jsonld")
.then(r=>r.json())
.then(j=>{
  db=j;

  /* SCHEMES */
  schemes=(j["@graph"]||[])
    .filter(x=>x["@type"]==="skos:ConceptScheme")
    .map(s=>({
      id:s["@id"].split("/").pop(),
      labels:s["skos:prefLabel"]||[]
    }));

  /* CONCEPTS */
  concepts=(j["@graph"]||[])
    .filter(x=>x["@type"]==="skos:Concept")
    .map(c=>({
      id:c["@id"].split("/").pop(),
      scheme:(c["skos:inScheme"]||[])[0]?.split("/").pop(),
      terms:extractTerms(c),
      definitions:extractDefs(c),
      sources:extractSources(c)
    }));

  concepts.forEach((c,i)=>map[c.id]=i);

  renderList();
  openFromHash();
  updateTopBar();
});

window.addEventListener("hashchange",openFromHash);
document.getElementById("search").addEventListener("input",renderList);

/* ========= LANGUAGE ========= */
function setLang(l){
  currentLang=l;
  document.getElementById("langBtn").textContent=l.toUpperCase();
  updateTopBar();
  renderList();
  openFromHash();
}

/* ========= TERM ========= */
function getTerm(c){
  return c.terms?.find(t=>t.lang===currentLang && t.type==="Preferred")
      || c.terms?.[0];
}

/* ========= SCHEME LABEL ========= */
function getSchemeLabel(s){
  const t=s.labels.find(l=>l["@language"]===currentLang);
  return t?.["@value"] || s.labels[0]?.["@value"] || s.id;
}

/* ========= LIST ========= */
function renderList(){
  const q=document.getElementById("search").value.toLowerCase();
  const el=document.getElementById("list");
  el.innerHTML="";

  schemes.forEach(s=>{
    const items=concepts.filter(c=>c.scheme===s.id)
      .filter(c=>{
        const t=getTerm(c)?.label?.toLowerCase()||"";
        return t.includes(q);
      });

    if(items.length===0) return;

    const header=document.createElement("div");
    header.className="schemeHeader";
    header.textContent=getSchemeLabel(s);
    el.appendChild(header);

    items.forEach(c=>{
      const t=getTerm(c)?.label||c.id;
      const div=document.createElement("div");
      div.className="item";
      const a=document.createElement("a");
      a.href="#/concept/"+encodeURIComponent(c.id);
      a.textContent=t;
      div.appendChild(a);
      el.appendChild(div);
    });
  });
}

/* ========= CONCEPT ========= */
function renderConcept(id){
  const c=concepts[map[id]];
  if(!c)return;

  const term=getTerm(c);
  const label=term?.label||id;
  const conceptURI=BASE_URI+encodeURIComponent(id);

  const defs=(c.definitions||[]).map(d=>`<div>${d.text}</div>`).join("")||"—";

  const src=(c.sources||[]).map(s=>{
    const v=s.label;
    return `<div><a class="link" href="${v}" target="_blank">${v}</a></div>`;
  }).join("")||"—";

  const feedbackURL=ISSUES_REPO_URL+"/issues/new?title="+encodeURIComponent(label);

  document.getElementById("view").innerHTML=`
    <h1>${label}</h1>
    <div class="section"><b>URI</b><br><a class="link" href="${conceptURI}">${conceptURI}</a></div>
    <div class="section"><b>Määritelmä</b>${defs}</div>
    <div class="section"><b>Lähteet</b>${src}</div>

    <div class="feedbackBox">
      <div class="feedbackHint">${UI[currentLang].feedbackHint}</div>
      <a class="link" href="${feedbackURL}" target="_blank">
        ${UI[currentLang].feedbackLink} ↗
      </a>
    </div>
  `;
}

/* ========= HASH ========= */
function openFromHash(){
  const h=window.location.hash;
  const m=h.match(/^#\/concept\/(.+)$/);
  if(!m) return;
  const id=decodeURIComponent(m[1]);
  if(map[id]!==undefined) renderConcept(id);
}

/* ========= JSON-LD ========= */
function extractTerms(c){
  const out=[];
  (c["skos:prefLabel"]||[]).forEach(t=>out.push({lang:t["@language"],label:t["@value"],type:"Preferred"}));
  (c["skos:altLabel"]||[]).forEach(t=>out.push({lang:t["@language"],label:t["@value"],type:"Alt"}));
  return out;
}
function extractDefs(c){
  return (c["skos:definition"]||[]).map(d=>({lang:d["@language"],text:d["@value"]}));
}
function extractSources(c){
  return (c["dcterms:source"]||[]).map(s=>({label:s["@value"]||s}));
}
</script>
</body>
</html>
