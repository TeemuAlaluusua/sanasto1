<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sanasto</title>

<style>
body{font-family:system-ui,Arial;margin:0;background:#f3f4f6;color:#111}
header{background:#fff;border-bottom:1px solid #e5e7eb;padding:12px 18px;display:flex;justify-content:space-between;align-items:center}
.layout{display:grid;grid-template-columns:320px 1fr;gap:16px;padding:16px}
.panel{background:#fff;border:1px solid #e5e7eb;border-radius:10px}
.list{max-height:80vh;overflow:auto}
.item{padding:10px 12px;border-bottom:1px solid #eee}
.item a{text-decoration:none;color:#2563eb;font-weight:600}
.concept{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:18px}
h1{margin:0 0 6px;font-size:24px}
.section{margin-top:18px}
.infoBox{border:1px solid #e5e7eb;border-radius:6px;background:#f9fafb;padding:10px 12px;margin-top:6px}
.infoRow{margin-bottom:6px}
.infoLang{font-weight:600;margin-right:6px}
.search{padding:6px 10px;border:1px solid #d1d5db;border-radius:6px}
.dropdown{display:inline-block;margin-left:8px}
.dropbtn{padding:6px 10px;border:1px solid #d1d5db;border-radius:6px;background:#fff;cursor:pointer}
.dropdown-content{display:none;position:absolute;background:#fff;border:1px solid #d1d5db;border-radius:6px}
.dropdown:hover .dropdown-content{display:block}
.dropdown-content div{padding:6px;cursor:pointer}
.dropdown-content div:hover{background:#f3f4f6}
.link{color:#2563eb;text-decoration:none}
.feedbackBox{margin-top:24px;padding-top:12px;border-top:1px solid #e5e7eb}
.feedbackHint{color:#6b7280;font-size:14px;margin-bottom:6px}

table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #eee;padding:8px;font-size:13px}
th{background:#f9fafb;text-align:left}
</style>
</head>

<body>

<header>
  <div>Sanasto</div>
  <div>
    <input id="search" class="search" placeholder="Search">

    <div class="dropdown">
      <button id="langBtn" class="dropbtn">FI</button>
      <div class="dropdown-content">
        <div onclick="setLang('fi')">Suomi</div>
        <div onclick="setLang('sv')">Svenska</div>
        <div onclick="setLang('en')">English</div>
      </div>
    </div>

    <div class="dropdown">
      <button class="dropbtn">Export</button>
      <div class="dropdown-content">
        <div onclick="exportJSONLD()">JSON-LD</div>
        <div onclick="exportTTL()">SKOS Turtle</div>
        <div onclick="exportRDF()">RDF/XML</div>
      </div>
    </div>

  </div>
</header>

<div class="layout">
  <div class="panel"><div id="list" class="list"></div></div>
  <div id="view" class="concept"></div>
</div>

<script>
const UI={
  fi:{
    select:"Valitse käsite",
    terms:"Termit",lang:"Kieli",term:"Termi",type:"Tyyppi",
    def:"Määritelmä",note:"Huomautus",src:"Lähteet",
    rel:"Liittyvät käsitteet",fb:"Voit antaa palautetta käsitteestä",
    fbLink:"Anna palautetta käsitteestä"
  },
  sv:{
    select:"Välj begrepp",
    terms:"Termer",lang:"Språk",term:"Term",type:"Typ",
    def:"Definition",note:"Anmärkning",src:"Källor",
    rel:"Relaterade begrepp",fb:"Du kan ge respons",
    fbLink:"Ge respons"
  },
  en:{
    select:"Select concept",
    terms:"Terms",lang:"Language",term:"Term",type:"Type",
    def:"Definition",note:"Note",src:"Sources",
    rel:"Related concepts",fb:"You can give feedback",
    fbLink:"Give feedback"
  }
};

const ISSUE_REPO="https://github.com/TeemuAlaluusua/sanasto1/issues/new";
const BASE_URI="https://teemualaluusua.github.io/sanasto1/#/concept/";

let currentLang="fi";
let concepts=[];
let map={};

const toArray=v=>v==null?[]:(Array.isArray(v)?v:[v]);
const asId=x=>typeof x==="object"?x["@id"]||"":x||"";
const esc=s=>String(s||"").replace(/[&<>"']/g,a=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[a]));

fetch("./sanasto.jsonld")
.then(r=>r.json())
.then(j=>{
  const graph=j["@graph"]||[];

  concepts=graph
    .filter(n=>{
      const t=toArray(n["@type"]);
      return t.includes("skos:Concept") || t.includes("http://www.w3.org/2004/02/skos/core#Concept");
    })
    .map(n=>{
      const uri=asId(n["@id"]);
      if(!uri.includes("#/concept/")) return null;
      const id=uri.split("#/concept/").pop();

      return{
        id,

        // FIX: schemeId oikein (# eikä /)
        scheme: toArray(n["skos:inScheme"])
          .map(u=>asId(u))
          .map(u=>u.includes("#") ? u.split("#").pop() : u.split("/").pop())[0] || "default",

        terms:toArray(n["skos:prefLabel"]).map(t=>({lang:t["@language"],label:t["@value"]})),
        defs:toArray(n["skos:definition"]).map(d=>({lang:d["@language"],text:d["@value"]})),
        notes:toArray(n["skos:note"]).map(d=>({lang:d["@language"],text:d["@value"]})),
        sources:toArray(n["dcterms:source"]).map(s=>({
          lang:s["@language"]||"",
          label:s["@value"]||"",
          url:s["@id"]||""
        })),
        related:toArray(n["skos:related"])
          .map(u=>asId(u))
          .filter(u=>u.includes("#/concept/"))
          .map(u=>u.split("#/concept/").pop())
      };
    })
    .filter(Boolean);

  concepts.forEach((c,i)=>map[c.id]=i);

  renderList();
  openFromHash();
});

function setLang(l){
  currentLang=l;
  document.getElementById("langBtn").textContent=l.toUpperCase();
  document.getElementById("view").textContent=UI[l].select;
  document.getElementById("view").textContent=UI[currentLang].select;
  renderList();
}

function term(c){
  return c.terms.find(t=>t.lang===currentLang) || c.terms[0];
}

function renderList(){
  const q=document.getElementById("search").value.toLowerCase();
  const el=document.getElementById("list");
  el.innerHTML="";

  const groups={};

  concepts.forEach(c=>{
   const t=c.terms.find(t=>t.lang===currentLang);
   if(!t) return;
   if(!t.label.toLowerCase().includes(q)) return;

   if(!groups[c.scheme]) groups[c.scheme]=[];
   groups[c.scheme].push(c);
  });

  Object.keys(groups).sort().forEach(scheme=>{
    const header=document.createElement("div");
    header.className="item";
    header.style.fontWeight="700";
    header.textContent=scheme;
    el.appendChild(header);

    groups[scheme]
      .sort((a,b)=>term(a).label.localeCompare(term(b).label,currentLang))
      .forEach(c=>{
        const div=document.createElement("div");
        div.className="item";
        const a=document.createElement("a");

        // FIX: varma render klikkauksessa
        a.href="#/concept/"+encodeURIComponent(c.id);
        a.onclick=e=>{
          e.preventDefault();
          location.hash="#/concept/"+encodeURIComponent(c.id);
          renderConcept(c.id);
        };

        a.textContent=term(c).label;
        div.appendChild(a);
        el.appendChild(div);
      });
  });
}

function renderConcept(id){
  const c=concepts[map[id]];
  if(!c) return;

  const t=UI[currentLang];
  const label=term(c)?.label||id;

  const termsRows=c.terms.map(tr=>`
    <tr>
      <td style="width:60px">${esc(tr.lang)}</td>
      <td>${esc(tr.label)}</td>
      <td style="width:90px">${esc(tr.type||"Preferred")}</td>
    </tr>
  `).join("");

  const defs=c.defs.map(d=>`
    <div class="infoRow">
      <span class="infoLang">${d.lang.toUpperCase()}</span>
      ${esc(d.text)}
    </div>
  `).join("")||"—";

  const notes=c.notes.map(d=>`
    <div class="infoRow">
      <span class="infoLang">${d.lang.toUpperCase()}</span>
      ${esc(d.text)}
    </div>
  `).join("")||"—";

  const src=c.sources.map(s=>{
    if(s.url){
      return `<div><a class="link" href="${esc(s.url)}" target="_blank">${esc(s.label)}</a></div>`;
    }
    return `<div>${esc(s.label)}</div>`;
  }).join("")||"—";

  const rel=c.related.map(r=>{
    const rc=concepts[map[r]];
    if(!rc) return "";
    return `<li><a class="link" href="#/concept/${encodeURIComponent(r)}">${esc(term(rc).label)}</a></li>`;
  }).join("");

  const issueURL=ISSUE_REPO+"?title="+encodeURIComponent(label);

  document.getElementById("view").innerHTML=`
    <h1>${esc(label)}</h1>

    <div class="section">
      <b>URI</b><br>
      <a class="link" href="${BASE_URI}${encodeURIComponent(id)}">${BASE_URI}${esc(id)}</a>
    </div>

    <div class="section">
      <h3>${t.terms}</h3>
      <table>
        <tr><th>${t.lang}</th><th>${t.term}</th><th>${t.type}</th></tr>
        ${termsRows}
      </table>
    </div>

    <div class="section">
      <h3>${t.def}</h3>
      <div class="infoBox">${defs}</div>
    </div>

    <div class="section">
      <h3>${t.note}</h3>
      <div class="infoBox">${notes}</div>
    </div>

    <div class="section">
      <h3>${t.src}</h3>
      <div class="infoBox">${src}</div>
    </div>

    <div class="section">
      <h3>${t.rel}</h3>
      <div class="infoBox"><ul>${rel}</ul></div>
    </div>

    <div class="feedbackBox">
      <div class="feedbackHint">${t.fb}</div>
      <a class="link" href="${issueURL}" target="_blank">${t.fbLink} ↗</a>
    </div>
  `;
}

function openFromHash(){
  const h=location.hash;
  const m=h.match(/^#\/concept\/(.+)$/);
  if(!m) return;

  let id=decodeURIComponent(m[1]).trim();
  if(map[id]!==undefined){renderConcept(id);return;}

  const slug=id.replace(/\s+/g,"-");
  if(map[slug]!==undefined){renderConcept(slug);}
}

window.addEventListener("hashchange",openFromHash);
document.getElementById("search").addEventListener("input",renderList);

function exportJSONLD(){window.open("sanasto.jsonld");}
function exportTTL(){alert("TTL export not configured");}
function exportRDF(){alert("RDF export not configured");}
</script>

</body>
</html>
