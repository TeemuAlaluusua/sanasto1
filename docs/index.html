<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sanasto</title>

<style>
body{
  font-family:system-ui,Arial;
  margin:0;
  background:#f3f4f6;
  color:#111;
  font-size:16px;
}
header{
  background:#fff;
  border-bottom:1px solid #e5e7eb;
  padding:12px 18px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.layout{
  display:grid;
  grid-template-columns:320px 1fr;
  gap:16px;
  padding:16px;
}
@media (max-width:800px){
  .layout{grid-template-columns:1fr;}
}
.panel{
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:10px;
}
.list{max-height:80vh;overflow:auto}
.item{padding:10px 12px;border-bottom:1px solid #eee}
.item a{font-weight:600;text-decoration:none;color:#2563eb}
.concept{
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:10px;
  padding:18px;
}
h1{margin:0 0 6px;font-size:24px}
.section{margin-top:18px}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #eee;padding:8px;font-size:13px}
th{background:#f9fafb;text-align:left}
.link{color:#2563eb;text-decoration:none}
.dropdown{position:relative;display:inline-block;margin-left:8px}
.dropbtn{padding:6px 10px;border:1px solid #d1d5db;border-radius:6px;background:#fff;cursor:pointer}
.dropdown-content{
  display:none;
  position:absolute;
  background:#fff;
  border:1px solid #d1d5db;
  border-radius:6px;
  min-width:180px;
  z-index:10;
  padding:6px;
}
.dropdown:hover .dropdown-content{display:block}
.dropdown-content div{padding:6px;cursor:pointer}
.dropdown-content div:hover{background:#f3f4f6}
.search{padding:6px 10px;border:1px solid #d1d5db;border-radius:6px;width:200px}
.noteSource{color:#6b7280;font-size:12px;margin-left:18px}

/* Palaute-osio (Suomi.fi-tyyli) */
.feedbackBox{
  margin-top:28px;
  padding-top:12px;
  border-top:1px solid #e5e7eb;
}
.feedbackHint{
  color:#6b7280;
  font-size:14px;
  margin-bottom:6px;
}
</style>
</head>

<body>
<header>
  <div id="title">Sanasto</div>

  <div>
    <input id="search" class="search" placeholder="Search">

    <div class="dropdown">
      <button class="dropbtn" id="langBtn">FI</button>
      <div class="dropdown-content">
        <div onclick="setLang('fi')">Suomi (FI)</div>
        <div onclick="setLang('sv')">Svenska (SV)</div>
        <div onclick="setLang('en')">English (EN)</div>
      </div>
    </div>

    <div class="dropdown">
      <button class="dropbtn" id="schemeBtn">Sanasto</button>
      <div class="dropdown-content" id="schemeFilter"></div>
    </div>

    <div class="dropdown">
      <button class="dropbtn" id="exportBtn">Export</button>
      <div class="dropdown-content">
        <div onclick="exportTTL()">SKOS Turtle (.ttl)</div>
        <div onclick="exportRDF()">RDF/XML (.rdf)</div>
        <div onclick="exportJSONLD()">JSON-LD (.jsonld)</div>
      </div>
    </div>
  </div>
</header>

<div class="layout">
  <div class="panel">
    <div class="list" id="list"></div>
  </div>
  <div class="concept" id="view">Valitse käsite</div>
</div>

<script>
/* ========= UI ========= */
const UI = {
  fi:{selectConcept:"Valitse käsite",terms:"Termit",definition:"Määritelmä",
      related:"Liittyvät käsitteet",sources:"Lähteet",uri:"URI",
      vocab:"Sanasto",export:"Export",lang:"Kieli",
      term:"Termi",type:"Tyyppi",note:"Huomautus",
      created:"Luotu",modified:"Muokattu viimeksi",
      feedbackHint:"Voit antaa palautetta käsitteestä sanaston vastuuorganisaatiolle.",
      feedbackLink:"Anna palautetta käsitteestä"},
  sv:{selectConcept:"Välj begrepp",terms:"Termer",definition:"Definition",
      related:"Relaterade begrepp",sources:"Källor",uri:"URI",
      vocab:"Ordlista",export:"Export",lang:"Språk",
      term:"Term",type:"Typ",note:"Anmärkning",
      created:"Skapad",modified:"Redigerad",
      feedbackHint:"Du kan ge respons om begreppet till vokabulärets ansvariga organisation.",
      feedbackLink:"Ge respons om begreppet"},
  en:{selectConcept:"Select concept",terms:"Terms",definition:"Definition",
      related:"Related concepts",sources:"Sources",uri:"URI",
      vocab:"Vocabulary",export:"Export",lang:"Language",
      term:"Term",type:"Type",note:"Note",
      created:"Created",modified:"Modified",
      feedbackHint:"You can give feedback about the concept to the responsible organization.",
      feedbackLink:"Give feedback about the concept"}
};

let db, concepts=[], map={};
let currentLang="fi";

/* HASH-URI (GitHub Pages -yhteensopiva) */
const BASE_URI="https://teemualaluusua.github.io/sanasto1/#/concept/";

/* Palautteet GitHub Issuesiin (vaihda tarvittaessa) */
const ISSUES_REPO_URL = "https://github.com/teemualaluusua/sanasto1";

/* DATE */
function fmtDate(dt){
  if(!dt) return "";
  const d=new Date(dt);
  return d.toLocaleString("fi-FI",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});
}

/* LOAD */
fetch("sanasto.jsonld")
.then(r=>r.json())
.then(j=>{
  db=j;

  concepts=(j["@graph"]||[]).map(c=>{
    return{
      id:c["@id"].split("/").pop(),
      terms:extractTerms(c),
      definitions:extractDefs(c),
      notes:extractNotes(c),
      sources:extractSources(c),
      relations:extractRelated(c),
      created:c["dcterms:created"]?.["@value"],
      modified:c["dcterms:modified"]?.["@value"]
    };
  });

  concepts.forEach((c,i)=>map[c.id]=i);

  renderList();
  openFromHash();
});

/* HASH LISTENER */
window.addEventListener("hashchange", openFromHash);

/* OPEN FROM HASH */
function openFromHash(){
  const h = window.location.hash; // #/concept/id
  const m = h.match(/^#\/concept\/(.+)$/);
  if(!m) return;
  const id = decodeURIComponent(m[1]);
  if(map[id]!==undefined){
    renderConcept(id);
  }
}

document.getElementById("search").addEventListener("input",renderList);

/* LANGUAGE */
function setLang(l){
  currentLang=l;
  document.getElementById("langBtn").textContent=l.toUpperCase();
  renderList();
  // Päivitä näkymä uudelleen jos käsite on auki
  openFromHash();
}

/* TERM */
function getTerm(c){
  return c.terms?.find(t=>t.lang===currentLang && t.type==="Preferred")
      || c.terms?.find(t=>t.lang===currentLang)
      || c.terms?.[0];
}

/* LIST */
function renderList(){
  const q=document.getElementById("search").value.toLowerCase();
  const el=document.getElementById("list");
  el.innerHTML="";

  const filtered=concepts.filter(c=>{
    const t=getTerm(c)?.label?.toLowerCase()||"";
    return t.includes(q);
  });

  filtered.forEach(c=>{
    const t=getTerm(c)?.label||c.id;

    const div=document.createElement("div");
    div.className="item";

    const a=document.createElement("a");
    a.href="#/concept/"+encodeURIComponent(c.id);
    a.textContent=t;

    div.appendChild(a);
    el.appendChild(div);
  });
}

/* HELPERS */
function isHttpUrl(s){ return /^https?:\/\//i.test(String(s||"")); }

function makeIssueURL(conceptLabel, conceptURI){
  const title = "Palaute käsitteestä: " + conceptLabel;
  const body =
    "Käsite: " + conceptLabel + "\n" +
    "URI: " + conceptURI + "\n\n" +
    "Palaute:\n";
  return ISSUES_REPO_URL.replace(/\/$/,"") + "/issues/new"
    + "?title=" + encodeURIComponent(title)
    + "&body=" + encodeURIComponent(body);
}

/* CONCEPT */
function renderConcept(id){
  const c=concepts[map[id]];
  if(!c)return;

  const tUI=UI[currentLang];
  const term=getTerm(c);
  const label = term?.label || id;
  const conceptURI = BASE_URI + encodeURIComponent(id);

  const termsRows=(c.terms||[]).map(t=>`
    <tr><td>${t.lang}</td><td>${t.label}</td><td>${t.type||""}</td></tr>
  `).join("");

  const defs=(c.definitions||[]).map(d=>`
    <div><b>${d.lang.toUpperCase()}</b> ${d.text}</div>
  `).join("")||"—";

  const notes=(c.notes||[]).map(n=>`
    <div>
      <b>${n.lang.toUpperCase()}</b> ${n.text}
      ${n.source?`<div class="noteSource">${n.source}${n.quote?" (suora lainaus)":""}</div>`:""}
    </div>
  `).join("")||"—";

  /* SOURCES: tee URL:t linkeiksi */
  const src=(c.sources||[]).map(s=>{
    const v = s.label;
    const link = isHttpUrl(v)
      ? `<a class="link" href="${v}" target="_blank" rel="noopener">${v}</a>`
      : String(v||"");
    return `<div>${s.lang?`<b>${s.lang.toUpperCase()}</b> `:""}${link}</div>`;
  }).join("") || "—";

  const rel=(c.relations?.related||[]).map(r=>{
    const rc=concepts[map[r]];
    const lbl=getTerm(rc)?.label||r;
    return `<li><a class="link" href="#/concept/${encodeURIComponent(r)}">${lbl}</a></li>`;
  }).join("");

  const feedbackURL = makeIssueURL(label, conceptURI);

  document.getElementById("view").innerHTML=`
    <h1>${label}</h1>

    <div class="section">
      <b>${tUI.uri}</b><br>
      <a class="link" href="${conceptURI}">${conceptURI}</a>
    </div>

    <div class="section">
      <h3>${tUI.terms}</h3>
      <table>
        <tr><th>${tUI.lang}</th><th>${tUI.term}</th><th>${tUI.type}</th></tr>
        ${termsRows}
      </table>
    </div>

    <div class="section"><h3>${tUI.definition}</h3>${defs}</div>
    <div class="section"><h3>${tUI.note}</h3>${notes}</div>
    <div class="section"><h3>${tUI.sources}</h3>${src}</div>

    <div class="section"><b>${tUI.created}</b><br>${fmtDate(c.created)||"—"}</div>
    <div class="section"><b>${tUI.modified}</b><br>${fmtDate(c.modified)||"—"}</div>

    <div class="section"><h3>${tUI.related}</h3><ul>${rel}</ul></div>

    <div class="feedbackBox">
      <div class="feedbackHint">${tUI.feedbackHint}</div>
      <a class="link" href="${feedbackURL}" target="_blank" rel="noopener">
        ${tUI.feedbackLink} ↗
      </a>
    </div>
  `;
}

/* JSON-LD */
function extractTerms(c){
  const out=[];
  (c["skos:prefLabel"]||[]).forEach(t=>out.push({lang:t["@language"],label:t["@value"],type:"Preferred"}));
  (c["skos:altLabel"]||[]).forEach(t=>out.push({lang:t["@language"],label:t["@value"],type:"Alt"}));
  return out;
}
function extractDefs(c){
  return (c["skos:definition"]||[]).map(d=>({lang:d["@language"],text:d["@value"]}));
}
function extractNotes(c){
  return (c["skos:note"]||[]).map(n=>({
    lang:n["@language"],
    text:n["@value"],
    source:n.source||"",
    quote:n.quote||false
  }));
}
function extractSources(c){
  return (c["dcterms:source"]||[]).map(s=>({
    label:s["@value"]||s,
    lang:s["@language"]||""
  }));
}
function extractRelated(c){
  return{
    related:(c["skos:related"]||[]).map(u=>u.split("/").pop())
  };
}

/* EXPORT */
function conceptURIExport(id){return BASE_URI + encodeURIComponent(id);}

function exportTTL(){
  let out=`@prefix skos: <http://www.w3.org/2004/02/skos/core#> .\n`;
  concepts.forEach(c=>{
    out+=`<${conceptURIExport(c.id)}> a skos:Concept ;\n`;
    c.terms?.forEach(t=>{
      out+=t.type==="Preferred"
        ?`  skos:prefLabel "${t.label}"@${t.lang} ;\n`
        :`  skos:altLabel "${t.label}"@${t.lang} ;\n`;
    });
    c.definitions?.forEach(d=>{
      out+=`  skos:definition "${d.text}"@${d.lang||"fi"} ;\n`;
    });
    out=out.replace(/;\n$/," .\n\n");
  });
  download("sanasto.ttl",out);
}
function exportJSONLD(){
  download("sanasto.jsonld",JSON.stringify(db,null,2));
}
function exportRDF(){
  download("sanasto.rdf","RDF export placeholder");
}
function download(name,text){
  const blob=new Blob([text],{type:"text/plain"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=name;
  a.click();
}
</script>
</body>
</html>
