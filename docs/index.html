<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sanasto</title>

<style>
body{font-family:system-ui,Arial;margin:0;background:#f3f4f6;color:#111;font-size:16px;}
header{background:#fff;border-bottom:1px solid #e5e7eb;padding:12px 18px;display:flex;justify-content:space-between;align-items:center;}
.layout{display:grid;grid-template-columns:320px 1fr;gap:16px;padding:16px;}
@media (max-width:800px){.layout{grid-template-columns:1fr;}}
.panel{background:#fff;border:1px solid #e5e7eb;border-radius:10px;}
.list{max-height:80vh;overflow:auto}
.item{padding:10px 12px;border-bottom:1px solid #eee}
.item a{font-weight:600;text-decoration:none;color:#2563eb}
.concept{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:18px;}
h1{margin:0 0 6px;font-size:24px}
.section{margin-top:18px}
.link{color:#2563eb;text-decoration:none}
.dropdown{position:relative;display:inline-block;margin-left:8px}
.dropbtn{padding:6px 10px;border:1px solid #d1d5db;border-radius:6px;background:#fff;cursor:pointer}
.dropdown-content{display:none;position:absolute;background:#fff;border:1px solid #d1d5db;border-radius:6px;min-width:180px;z-index:10;padding:6px;}
.dropdown:hover .dropdown-content{display:block}
.dropdown-content div{padding:6px;cursor:pointer}
.dropdown-content div:hover{background:#f3f4f6}
.search{padding:6px 10px;border:1px solid #d1d5db;border-radius:6px;width:200px}
.infoBox{border:1px solid #e5e7eb;border-radius:6px;background:#f9fafb;padding:10px 12px;margin-top:6px;}
.infoRow{margin-bottom:6px;}
.infoLang{font-weight:600;margin-right:6px;}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #eee;padding:6px;font-size:13px;text-align:left}
th{background:#f9fafb}
</style>
</head>

<body>
<header>
  <div>Sanasto</div>

  <div>
    <input id="search" class="search" placeholder="Search">

    <div class="dropdown">
      <button class="dropbtn" id="langBtn">FI</button>
      <div class="dropdown-content">
        <div onclick="setLang('fi')">Suomi</div>
        <div onclick="setLang('sv')">Svenska</div>
        <div onclick="setLang('en')">English</div>
      </div>
    </div>

    <div class="dropdown">
      <button class="dropbtn">Export</button>
      <div class="dropdown-content">
        <div onclick="exportJSONLD()">JSON-LD</div>
      </div>
    </div>
  </div>
</header>

<div class="layout">
  <div class="panel">
    <div class="list" id="list"></div>
  </div>
  <div class="concept" id="view">Valitse käsite</div>
</div>

<script>
const SKOS="http://www.w3.org/2004/02/skos/core#";
const BASE="https://teemualaluusua.github.io/sanasto1/#/concept/";
const ISSUE_BASE="https://github.com/TeemuAlaluusua/sanasto1/issues/new";

let concepts=[],map={},currentLang="fi";

function toArray(v){return v==null?[]:(Array.isArray(v)?v:[v]);}
function asId(x){return typeof x==="object"?x["@id"]||"":x||"";}
function esc(s){return String(s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));}

function isConcept(o){
  const t=toArray(o["@type"]).map(asId);
  return t.includes("skos:Concept") || t.includes(SKOS+"Concept");
}

function issueURL(label,uri){
  return ISSUE_BASE
    +"?title="+encodeURIComponent("Palaute käsitteestä: "+label)
    +"&body="+encodeURIComponent("Käsite: "+label+"\nURI: "+uri);
}

/* LOAD */
fetch("./sanasto.jsonld")
.then(r=>r.json())
.then(j=>{
  const graph=j["@graph"]||[];

  concepts=graph.filter(isConcept).map(c=>{
    const id=asId(c["@id"]).split("#/concept/").pop();
    return{
      id,
      terms:extractTerms(c),
      defs:extractDefs(c),
      notes:extractNotes(c),
      src:extractSources(c),
      rel:extractRelated(c)
    };
  });

  concepts.forEach((c,i)=>map[c.id]=i);

  renderList();
  openFromHash();
})
.catch(()=>{
  document.getElementById("list").innerHTML="Virhe: sanasto.jsonld ei lataudu";
});

window.addEventListener("hashchange",openFromHash);
document.getElementById("search").addEventListener("input",renderList);

function setLang(l){
  currentLang=l;
  document.getElementById("langBtn").textContent=l.toUpperCase();
  renderList();
  openFromHash();
}

function term(c){
  return c.terms.find(t=>t.lang===currentLang) || c.terms[0];
}

function renderList(){
  const q=document.getElementById("search").value.toLowerCase();
  const el=document.getElementById("list");
  el.innerHTML="";

  concepts
    .filter(c=>term(c)?.label?.toLowerCase().includes(q))
    .sort((a,b)=>term(a).label.localeCompare(term(b).label,"fi"))
    .forEach(c=>{
      const d=document.createElement("div");
      d.className="item";
      d.innerHTML=`<a href="#/concept/${encodeURIComponent(c.id)}">${term(c).label}</a>`;
      el.appendChild(d);
    });
}

/* CONCEPT VIEW */
function renderConcept(id){
  const c=concepts[map[id]];
  if(!c)return;

  const label=term(c).label;
  const uri=BASE+encodeURIComponent(id);

  const termsRows=c.terms.map(t=>`
    <tr><td>${t.lang}</td><td>${esc(t.label)}</td><td>${t.type}</td></tr>
  `).join("");

  const defs=c.defs.map(d=>`
    <div class="infoRow"><span class="infoLang">${d.lang.toUpperCase()}</span>${esc(d.text)}</div>
  `).join("")||"—";

  const notes=c.notes.map(n=>`
    <div class="infoRow"><span class="infoLang">${n.lang.toUpperCase()}</span>${esc(n.text)}</div>
  `).join("")||"—";

  const src=c.src.map(s=>{
    if(s.url){
      return `<div><a class="link" href="${s.url}" target="_blank">${esc(s.label||s.url)}</a></div>`;
    }
    return `<div>${esc(s.label)}</div>`;
  }).join("")||"—";

  const rel=c.rel.map(r=>{
    const rc=concepts[map[r]];
    const lbl=rc?term(rc).label:r;
    return `<li><a class="link" href="#/concept/${encodeURIComponent(r)}">${lbl}</a></li>`;
  }).join("");

  document.getElementById("view").innerHTML=`
    <h1>${label}</h1>

    <div class="section">
      <b>URI</b><br>
      <a class="link" href="${uri}">${uri}</a>
    </div>

    <div class="section">
      <h3>Termit</h3>
      <table>
        <tr><th>Kieli</th><th>Termi</th><th>Tyyppi</th></tr>
        ${termsRows}
      </table>
    </div>

    <div class="section">
      <h3>Määritelmä</h3>
      <div class="infoBox">${defs}</div>
    </div>

    <div class="section">
      <h3>Huomautus</h3>
      <div class="infoBox">${notes}</div>
    </div>

    <div class="section">
      <h3>Lähteet</h3>
      <div class="infoBox">${src}</div>
    </div>

    <div class="section">
      <h3>Liittyvät käsitteet</h3>
      <ul>${rel}</ul>
    </div>

    <div class="section">
      <div class="infoBox">
        Voit antaa palautetta käsitteestä sanaston vastuuorganisaatiolle.<br>
        <a class="link" href="${issueURL(label,uri)}" target="_blank">
          Anna palautetta käsitteestä ↗
        </a>
      </div>
    </div>
  `;
}

function openFromHash(){
  const m=location.hash.match(/^#\/concept\/(.+)$/);
  if(!m)return;
  const id=decodeURIComponent(m[1]);
  if(map[id]!==undefined) renderConcept(id);
}

/* JSON-LD parsing */
function extractTerms(c){
  const out=[];
  toArray(c["skos:prefLabel"]).forEach(t=>out.push({lang:t["@language"],label:t["@value"],type:"Preferred"}));
  toArray(c["skos:altLabel"]).forEach(t=>out.push({lang:t["@language"],label:t["@value"],type:"Alt"}));
  return out;
}
function extractDefs(c){
  return toArray(c["skos:definition"]).map(d=>({lang:d["@language"],text:d["@value"]}));
}
function extractNotes(c){
  return toArray(c["skos:note"]).map(n=>({lang:n["@language"],text:n["@value"]}));
}
function extractSources(c){
  return toArray(c["dcterms:source"]).map(s=>({
    lang:s["@language"]||"",
    label:s["@value"]||"",
    url:s["@id"]||""
  }));
}
function extractRelated(c){
  return toArray(c["skos:related"]).map(u=>asId(u).split("/").pop());
}

function exportJSONLD(){
  window.open("sanasto.jsonld","_blank");
}
</script>
</body>
</html>
