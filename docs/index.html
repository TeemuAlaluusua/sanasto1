<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sanasto</title>

<style>
body{font-family:system-ui,Arial;margin:0;background:#f3f4f6;color:#111}
header{background:#fff;border-bottom:1px solid #e5e7eb;padding:12px 18px;display:flex;justify-content:space-between;align-items:center}
.layout{display:grid;grid-template-columns:320px 1fr;gap:16px;padding:16px}
.panel{background:#fff;border:1px solid #e5e7eb;border-radius:10px}
.list{max-height:80vh;overflow:auto}
.item{padding:10px 12px;border-bottom:1px solid #eee}
.item a{font-weight:600;text-decoration:none;color:#2563eb}
.concept{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:18px}
h1{margin:0 0 6px;font-size:28px}
.meta{color:#6b7280;font-size:12px}
.section{margin-top:18px}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #eee;padding:8px;font-size:13px}
th{background:#f9fafb;text-align:left}

.dropdown{position:relative;display:inline-block;margin-left:8px}
.dropbtn{padding:6px 10px;border:1px solid #d1d5db;border-radius:6px;background:#fff;cursor:pointer}
.dropdown-content{display:none;position:absolute;background:#fff;border:1px solid #d1d5db;border-radius:6px;min-width:180px;z-index:10;padding:6px}
.dropdown:hover .dropdown-content{display:block}
.dropdown-content div{padding:6px;cursor:pointer}
.dropdown-content div:hover{background:#f3f4f6}

.search{padding:6px 10px;border:1px solid #d1d5db;border-radius:6px;width:200px}
</style>
</head>

<body>
<header>
  <div id="title">Sanasto</div>

  <div>
    <input id="search" class="search" placeholder="Search">

    <!-- Language -->
    <div class="dropdown">
      <button class="dropbtn" id="langBtn">FI</button>
      <div class="dropdown-content">
        <div onclick="setLang('fi')">Suomi (FI)</div>
        <div onclick="setLang('sv')">Svenska (SV)</div>
        <div onclick="setLang('en')">English (EN)</div>
      </div>
    </div>

    <!-- Status -->
    <div class="dropdown">
      <button class="dropbtn" id="statusBtn">Status</button>
      <div class="dropdown-content">
        <div onclick="setStatus('')">All</div>
        <div onclick="setStatus('Luonnos')">Luonnos</div>
        <div onclick="setStatus('Hyväksytty')">Hyväksytty</div>
      </div>
    </div>

    <!-- Scheme -->
    <div class="dropdown">
      <button class="dropbtn" id="schemeBtn">Sanasto</button>
      <div class="dropdown-content" id="schemeFilter"></div>
    </div>

    <!-- Export -->
    <div class="dropdown">
      <button class="dropbtn" id="exportBtn">Export</button>
      <div class="dropdown-content">
        <div onclick="exportTTL()">SKOS Turtle (.ttl)</div>
        <div onclick="exportRDF()">RDF/XML (.rdf)</div>
        <div onclick="exportJSONLD()">JSON-LD (.jsonld)</div>
      </div>
    </div>
  </div>
</header>

<div class="layout">
  <div class="panel">
    <div class="list" id="list"></div>
  </div>

  <div class="concept" id="view">Valitse käsite</div>
</div>

<script>
/* ===== UI TRANSLATIONS ===== */
const UI = {
  fi:{
    selectConcept:"Valitse käsite",
    terms:"Termit",
    definition:"Määritelmä",
    related:"Liittyvät käsitteet",
    scheme:"Kuuluu sanastoon",
    sources:"Lähteet",
    uri:"URI",
    status:"Status",
    vocab:"Sanasto",
    export:"Export",
    lang:"Kieli",
    term:"Termi",
    type:"Tyyppi"
  },
  sv:{
    selectConcept:"Välj begrepp",
    terms:"Termer",
    definition:"Definition",
    related:"Relaterade begrepp",
    scheme:"Ingår i ordlista",
    sources:"Källor",
    uri:"URI",
    status:"Status",
    vocab:"Ordlista",
    export:"Export",
    lang:"Språk",
    term:"Term",
    type:"Typ"
  },
  en:{
    selectConcept:"Select concept",
    terms:"Terms",
    definition:"Definition",
    related:"Related concepts",
    scheme:"Member of vocabulary",
    sources:"Sources",
    uri:"URI",
    status:"Status",
    vocab:"Vocabulary",
    export:"Export",
    lang:"Language",
    term:"Term",
    type:"Type"
  }
};

let db, concepts=[], map={};
let currentLang="fi";
let statusFilter="";
let schemeFilter="";
const BASE_URI="https://w3id.org/betk/sanasto/";

function updateUITexts(){
  const t=UI[currentLang];
  document.getElementById("view").textContent=t.selectConcept;
  document.getElementById("statusBtn").textContent=t.status;
  document.getElementById("schemeBtn").textContent=t.vocab;
  document.getElementById("exportBtn").textContent=t.export;
}

/* ===== LOAD DATA ===== */
fetch("sanasto.jsonld")
.then(r=>r.json())
.then(j=>{
  db=j;

  concepts=(j["@graph"]||[]).map(c=>{
    return{
      id:c["@id"].split("/").pop(),
      terms:extractTerms(c),
      definitions:extractDefs(c),
      relations:extractRelated(c)
    };
  });

  concepts.forEach((c,i)=>map[c.id]=i);
  renderList();
});

document.getElementById("search").addEventListener("input",renderList);

/* ===== LANGUAGE ===== */
function setLang(l){
  currentLang=l;
  document.getElementById("langBtn").textContent=l.toUpperCase();
  updateUITexts();
  renderList();
}

/* ===== FILTERS ===== */
function setStatus(s){statusFilter=s;renderList();}
function setScheme(id){schemeFilter=id;renderList();}

/* ===== HELPERS ===== */
function getTerm(c){
  return c.terms?.find(t=>t.lang===currentLang && t.type==="Suositettava termi")
      || c.terms?.find(t=>t.lang===currentLang)
      || c.terms?.[0];
}

function getDef(c){
  return c.definitions?.find(d=>d.lang===currentLang)
      || c.definitions?.[0];
}

/* ===== LIST ===== */
function renderList(){
  const q=document.getElementById("search").value.toLowerCase();
  const el=document.getElementById("list");

  const filtered=concepts.filter(c=>{
    const t=getTerm(c)?.label?.toLowerCase()||"";
    const d=getDef(c)?.text?.toLowerCase()||"";
    return t.includes(q)||d.includes(q);
  });

  el.innerHTML=filtered.map(c=>{
    const t=getTerm(c)?.label||c.id;
    return `<div class="item"><a href="#/concept/${c.id}" onclick="renderConcept('${c.id}')">${t}</a></div>`;
  }).join("");
}

const src=(c.sources||[]).map(s=>`
  <div>${s.lang?`<b>${s.lang.toUpperCase()}</b> `:""}${s.label}</div>
`).join("") || "—";
  
const defs=(c.definitions||[]).map(d=>`
  <div><b>${d.lang.toUpperCase()}</b> ${d.text}</div>
`).join("") || "—";

<div class="section">
  <h3>${tUI.definition}</h3>
  ${defs}
</div>

<div class="section">
  <h3>Huomautus</h3>
  ${notes}
</div>

<div class="section">
  <h3>${tUI.sources}</h3>
  ${src}
</div>
  
 const notes=(c.notes||[]).map(n=>`
  <div>
    <b>${n.lang.toUpperCase()}</b>
    ${n.text}
    ${n.source?`<div style="color:#6b7280;font-size:12px">${n.source}${n.quote?" (suora lainaus)":""}</div>`:""}
  </div>
`).join("") || "—"; 
  
/* ===== CONCEPT VIEW ===== */
function renderConcept(id){
  const c=concepts[map[id]];
  if(!c)return;

  const tUI=UI[currentLang];
  const term=getTerm(c);
  const def=getDef(c);

  const termsRows=(c.terms||[]).map(t=>`
    <tr>
      <td>${t.lang}</td>
      <td>${t.label}</td>
      <td>${t.type||""}</td>
    </tr>`).join("");

  const rel=(c.relations?.related||[]).map(r=>{
    const rc=concepts[map[r]];
    const lbl=getTerm(rc)?.label||r;
    return `<li><a class="link" href="#/concept/${r}" onclick="renderConcept('${r}')">${lbl}</a></li>`;
  }).join("");

  document.getElementById("view").innerHTML=`
    <h1>${term?.label||id}</h1>

    <div class="section">
      <b>${tUI.uri}</b><br>${BASE_URI+id}
    </div>

    <div class="section">
      <h3>${tUI.terms}</h3>
      <table>
        <tr>
          <th>${tUI.lang}</th>
          <th>${tUI.term}</th>
          <th>${tUI.type}</th>
        </tr>
        ${termsRows}
      </table>
    </div>

    <div class="section">
      <h3>${tUI.definition}</h3>
      <p>${def?.text||"—"}</p>
    </div>

    <div class="section">
      <h3>${tUI.related}</h3>
      <ul>${rel||""}</ul>
    </div>
  `;
}

/* ===== JSON-LD PARSING ===== */
function extractTerms(c){
  const out=[];
  (c["skos:prefLabel"]||[]).forEach(t=>{
    out.push({lang:t["@language"],label:t["@value"],type:"Preferred"});
  });
  (c["skos:altLabel"]||[]).forEach(t=>{
    out.push({lang:t["@language"],label:t["@value"],type:"Alt"});
  });
  return out;
}

function extractDefs(c){
  return (c["skos:definition"]||[]).map(d=>({
    lang:d["@language"],
    text:d["@value"]
  }));
}

function extractRelated(c){
  return{
    related:(c["skos:related"]||[]).map(u=>u.split("/").pop())
  };
}

function extractNotes(c){
  return (c["skos:note"]||[]).map(n=>({
    lang:n["@language"],
    text:n["@value"],
    source:n.source||"",
    quote:n.quote||false
  }));
}

function extractSources(c){
  return (c["dct:source"]||[]).map(s=>({
    label:s["@value"]||s,
    lang:s["@language"]||""
  }));
}
  
/* ===== EXPORT ===== */
function conceptURI(id){return BASE_URI+id;}

function exportTTL(){
  let out=`@prefix skos: <http://www.w3.org/2004/02/skos/core#> .\n`;

  concepts.forEach(c=>{
    out+=`<${conceptURI(c.id)}> a skos:Concept ;\n`;
    c.terms?.forEach(t=>{
      if(t.type==="Preferred")
        out+=`  skos:prefLabel "${t.label}"@${t.lang} ;\n`;
      else
        out+=`  skos:altLabel "${t.label}"@${t.lang} ;\n`;
    });
    c.definitions?.forEach(d=>{
      out+=`  skos:definition "${d.text}"@${d.lang||"fi"} ;\n`;
    });
    out=out.replace(/;\n$/," .\n\n");
  });

  concepts=(j["@graph"]||[]).map(c=>{
  return{
    id:c["@id"].split("/").pop(),
    terms:extractTerms(c),
    definitions:extractDefs(c),
    notes:extractNotes(c),
    sources:extractSources(c),
    relations:extractRelated(c)
  };
});



  
  download("sanasto.ttl",out);
}

function exportJSONLD(){
  download("sanasto.jsonld",JSON.stringify(db,null,2));
}

function exportRDF(){
  download("sanasto.rdf","RDF export placeholder");
}

function download(name,text){
  const blob=new Blob([text],{type:"text/plain"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=name;
  a.click();
}

updateUITexts();
</script>
</body>
</html>
