<script>
let db,concepts=[],map={},currentLang="fi";

const SKOS="http://www.w3.org/2004/02/skos/core#";

function toArray(v){return v==null?[]:(Array.isArray(v)?v:[v]);}
function asId(x){return typeof x==="object"?x["@id"]||"":x||"";}
function escapeHtml(str){
  return String(str||"").replace(/[&<>"']/g,s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s]));
}

function isConcept(obj){
  const t=toArray(obj["@type"]).map(asId);
  return t.includes("skos:Concept") || t.includes(SKOS+"Concept");
}

fetch("./sanasto.jsonld")
.then(r=>r.json())
.then(j=>{
  db=j;
  const graph=j["@graph"]||[];

  concepts = graph
    .filter(isConcept)
    .map(c=>{
      const rawId=asId(c["@id"]).split("#/concept/").pop();
      return{
        id:rawId,
        terms:extractTerms(c),
        definitions:extractDefs(c),
        notes:extractNotes(c),
        sources:extractSources(c),
        related:extractRelated(c)
      };
    });

  concepts.forEach((c,i)=>map[c.id]=i);

  renderList();
  openFromHash();
});

window.addEventListener("hashchange",openFromHash);
document.getElementById("search").addEventListener("input",renderList);

function setLang(l){
  currentLang=l;
  document.getElementById("langBtn").textContent=l.toUpperCase();
  renderList();
  openFromHash();
}

function getTerm(c){
  return c.terms?.find(t=>t.lang===currentLang && t.type==="Preferred")
      || c.terms?.find(t=>t.lang===currentLang)
      || c.terms?.[0];
}

function renderList(){
  const q=document.getElementById("search").value.toLowerCase();
  const el=document.getElementById("list");
  el.innerHTML="";

  concepts
    .filter(c=>getTerm(c)?.label?.toLowerCase().includes(q))
    .sort((a,b)=>getTerm(a).label.localeCompare(getTerm(b).label,"fi"))
    .forEach(c=>{
      const div=document.createElement("div");
      div.className="item";
      const a=document.createElement("a");
      a.href="#/concept/"+encodeURIComponent(c.id);
      a.textContent=getTerm(c).label;
      div.appendChild(a);
      el.appendChild(div);
    });
}

/* ===== FULL CONCEPT VIEW ===== */
function renderConcept(id){
  const c=concepts[map[id]];
  if(!c)return;

  const label=getTerm(c)?.label||id;

  /* TERMS TABLE */
  const termsRows=(c.terms||[]).map(t=>`
    <tr><td>${t.lang}</td><td>${escapeHtml(t.label)}</td><td>${t.type||""}</td></tr>
  `).join("");

  /* DEFINITIONS */
  const defs=(c.definitions||[]).map(d=>`
    <div class="infoRow"><span class="infoLang">${(d.lang||"").toUpperCase()}</span>${escapeHtml(d.text)}</div>
  `).join("")||"—";

  /* NOTES */
  const notes=(c.notes||[]).map(n=>`
    <div class="infoRow"><span class="infoLang">${(n.lang||"").toUpperCase()}</span>${escapeHtml(n.text)}</div>
  `).join("")||"—";

  /* SOURCES WITH URI */
  const src=(c.sources||[]).map(s=>{
    if(s.url){
      return `<div><a class="link" href="${s.url}" target="_blank">${escapeHtml(s.label||s.url)}</a></div>`;
    }
    if(/^https?:\/\//i.test(s.label)){
      return `<div><a class="link" href="${s.label}" target="_blank">${escapeHtml(s.label)}</a></div>`;
    }
    return `<div>${escapeHtml(s.label)}</div>`;
  }).join("")||"—";

  /* RELATED */
  const rel=(c.related||[]).map(r=>{
    const rc=concepts[map[r]];
    const lbl=getTerm(rc)?.label||r;
    return `<li><a class="link" href="#/concept/${encodeURIComponent(r)}">${lbl}</a></li>`;
  }).join("");

  document.getElementById("view").innerHTML=`
    <h1>${label}</h1>

    <div class="section">
      <b>URI</b><br>
      <a class="link" href="#/concept/${encodeURIComponent(id)}">#/concept/${id}</a>
    </div>

    <div class="section">
      <h3>Termit</h3>
      <table>
        <tr><th>Kieli</th><th>Termi</th><th>Tyyppi</th></tr>
        ${termsRows}
      </table>
    </div>

    <div class="section">
      <h3>Määritelmä</h3>
      <div class="infoBox">${defs}</div>
    </div>

    <div class="section">
      <h3>Huomautus</h3>
      <div class="infoBox">${notes}</div>
    </div>

    <div class="section">
      <h3>Lähteet</h3>
      <div class="infoBox">${src}</div>
    </div>

    <div class="section">
      <h3>Liittyvät käsitteet</h3>
      <ul>${rel}</ul>
    </div>
  `;
}

function openFromHash(){
  const h=window.location.hash;
  const m=h.match(/^#\/concept\/(.+)$/);
  if(!m) return;

  let id=decodeURIComponent(m[1]).trim();

  if(map[id]!==undefined){renderConcept(id);return;}

  const slug=id.replace(/\s+/g,"-");
  if(map[slug]!==undefined){renderConcept(slug);return;}
}

/* JSON-LD parsing */
function extractTerms(c){
  const out=[];
  toArray(c["skos:prefLabel"]).forEach(t=>out.push({lang:t["@language"],label:t["@value"],type:"Preferred"}));
  toArray(c["skos:altLabel"]).forEach(t=>out.push({lang:t["@language"],label:t["@value"],type:"Alt"}));
  return out;
}
function extractDefs(c){
  return toArray(c["skos:definition"]).map(d=>({lang:d["@language"],text:d["@value"]}));
}
function extractNotes(c){
  return toArray(c["skos:note"]).map(n=>({lang:n["@language"],text:n["@value"]}));
}
function extractSources(c){
  return toArray(c["dcterms:source"]).map(s=>({
    lang:s["@language"]||"",
    label:s["@value"]||"",
    url:s["@id"]||""
  }));
}
function extractRelated(c){
  return toArray(c["skos:related"]).map(u=>asId(u).split("/").pop());
}

/* export placeholders */
function exportTTL(){}
function exportRDF(){}
function exportJSONLD(){}
</script>
